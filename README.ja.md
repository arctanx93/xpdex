# xpdex

X680x0 の音源ドライバとして知られている MXDRV 用の PCM データファイル形式である PDX ファイルの中から、構成要素である PCM ファイルを抽出するための Python スクリプトです。
X680x0 以外での環境下でも、エミュレータに頼らずに曲データの開発ができることを目指していましたが、Emscripten とかで X680x0 オリジナルの MDX / PDX の作成環境が Web ブラウザ上で動くようになるなら、もうそれで構わないような気もしてきました。

## 仕様

以下の仕様を想定して作られていますが、その通りになっていないところもあるかも知れません。予めご了承ください。

- EX-PDX フォーマットに対応しています(が、判定が常に正確とは限りません)
- 以下のような、ヘッダが通常と異なる PDX ファイルでも、可能な範囲で抽出を試みます
  - ヘッダサイズが 768 バイトの倍数でない(208 バイトとか 1024 バイトとか)
  - ノート番号の大きい PCM データが、ノート番号の小さい PCM データよりも前方に置かれている
  - 中身の無いヘッダが数バンク分付加している　等
- エラーチェックは場所にも依りますが、甘かったり、していなかったりします
  - あなたの大事なファイルやシステムが破壊されないとも限らないので、プログラムの実行に当たってはバックアップを取るなどして、事故のないようにご注意下さい
  - 特に PDX ファイルでないファイルを指定するのは危険が伴うのでご遠慮ください(PDX ファイルかどうかの判定を厳密に行っていないため)
- バグやその他の理由で、期待通りの動作をしなかったり、他の `pdex` 系ソフトウェアと動作(結果)等が異なる場合があるかも知れません
- 上記以外の仕様はソースを読むとある程度分かるかも知れませんが、ソースがひどくて読みにくいのも仕様(の一部)です
- Python プログラミングの学習中に試行錯誤で作ったものなので、コードの品質はお察しください
- コードやドキュメントにはルールやお作法に則っていないところが少なからずあります
- **本プログラムは無保証です**

## 必要な環境

- Python3 が動く環境が必要です(Python2 系は動作確認していません)
- 標準でインストールされるパッケージだけで動作すると思いますが、Python のバージョンによってはそうでないかも知れません
- 作者は python 3.9.16 on cygwin64 (Windows11) 上で動作確認をしています
- 必要に応じて、環境に合った shebang を追加するのも良いかも知れません

## 使用方法

```plain
$ python xpdex.py --help
usage: xpdex.py [-h] [-f] [-p [PREFIX]] [-v] [-V] PDX_filename [pcm_num ...]

Extract PCM file(s) from a PDX file.

positional arguments:
  PDX_filename          specify PDX filename
  pcm_num               specify PCM number to extract (0-8255)

optional arguments:
  -h, --help            show this help message and exit
  -f, --force           force to overwrite pcm file(s)
  -p [PREFIX], --prefix [PREFIX]
                        specify prefix of PCM files
  -v, --verbose         increase verbose level
  -V, --version         show program's version number and exit

Copyright (c) 2023-2025 ArctanX
```

以下の動作を想定して作られていますが、その通りになっていないところもあるかも知れません。予めご了承ください。

- 指定した PDX ファイルから、構成要素である PCM ファイルを抽出(展開)します
  - PCM ファイル名の数字部分は、非 EX-PDX と判定された場合は 2 桁 (`00.pcm` 等) 、EX-PDX と判定された場合は 5 桁 (`00000.pcm` 等) となります
- pcm_num には抽出したい 1 つ以上の PCM 番号 (0 ～ 8255) を半角スペースで区切りながら指定します (例 : `1 5 7 123 4096`)
  - pcm_num を指定しない場合は PDX ファイル内の全 PCM ファイルをできる限り抽出します
  - pcm_num は昇順に指定する必要はなく任意の順番で構いませんが、抽出は PCM 番号の小さいものから順に行われます
  - pcm_num で指定した PCM 番号が PDX ファイル内に無かった場合は無視されます(エラーにはなりません)
  - 抽出 PCM 番号(ノート)指定にはバンク番号や音程表記(`o4c` 等)は使えません
- 指定した PDX ファイルが見つからない場合は、拡張子 `.pdx` / `.PDX` が補完されて再試行されます

### オプション

- `-h`: ヘルプを表示してプログラムを終了します
- `-f`: 出力ファイルと同名のファイルが既に存在している場合に、確認無しに上書きします
  - 指定していない場合は上書き確認があります (デフォルト)
- `-p`: 抽出 PCM ファイル名の前に指定した文字列が入ります
  - `-p foo` とした場合は、`foo00.pcm`, `foo01.pcm`, ... となります
  - `-p` だけの場合は PDX ファイル名を使うので、`bar.pdx` の場合は `bar_00.pcm`, `bar_01.pcm`, ... となります
    - EX-PDX 判定された場合は数字部分は 5 桁になります
  - いずれの場合も、他のオプションの前、またはコマンドラインの一番最後で指定してください(さもないと誤動作の原因になります)
- `-v`: バーボーズレベルを上げます
  - 通常は `-v` / `-vv` くらいで良いと思います(`-vvv` 以上は興味のある方だけどうぞ)
- `-V`: バージョン番号を表示してプログラムを終了します

## 謝辞

機能要件や仕様を考える際に `tpdex` や `bpdex` のドキュメントを参考にしました。作者の皆様に感謝いたします。

## 作者

[ArctanX](https://github.com/arctanx93)

## ライセンス

MIT License  
© 2023–2025 ArctanX
